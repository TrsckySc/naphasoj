<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>基础数据维护 - SNAKE-API</title>
  <link href="./lib/bootstrap.min.css" rel="stylesheet">
  <style>
    #base-data,
    #base-page-data {
      position: relative;
      width: 100%;
      height: 400px;
    }

    /* 去掉json编辑器的错误图标 */
    .ace_gutter-cell.ace_error {
      background-image: none !important;
    }
  </style>
</head>

<body>
  <!-- nav -->
  <div>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/mock">SNAKE-API <small>Mini</small></a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-between" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-item nav-link" href="/mock">接口列表 <span class="sr-only">(current)</span></a>
          <a class="nav-item nav-link active" href="/mock/base-data.html">基础数据维护</a>
          <a class="nav-item nav-link" href="/mock/prefix.html">接口前缀维护</a>
        </div>
        <div>
          <a class="btn-link text-secondary" href="https://www.snake-api.com" target="_blank">SNAKE-API 官网</a>
        </div>
      </div>
    </nav>
  </div>

  <div class="p-3 row">
    <div class="col">
      <h4>响应体基础数据</h4>
      <div id="base-data" class="form-control"></div>
      <div class="mt-2">
        <button type="button" class="btn btn-primary btm-sm" onclick="saveBase()">保存</button>
      </div>
    </div>
    <div class="col">
      <h4>响应体基础分页数据</h4>
      <div id="base-page-data" class="form-control"></div>
      <div class="mt-2">
        <button type="button" class="btn btn-primary btm-sm" onclick="saveBasePage()">保存</button>
      </div>
    </div>
  </div>

  <!-- alert info -->
  <div id="alert" class="alert alert-success position-fixed w-50" role="alert"
    style="display: none;top:40px;left:50%;margin-left:-25%;z-index:9999999999"></div>

  <script src="./lib/jquery.min.js"></script>
  <script src="./lib/popper.min.js"></script>
  <script src="./lib/handlebars.min.js"></script>
  <script src="./lib/bootstrap.min.js"></script>
  <script src="./lib/json5.min.js"></script>
  <script src="./lib/ace-1.4.4/src/ace.js"></script>
  <script src="./lib/ace-1.4.4/src/theme-chrome.js"></script>
  <script src="./lib/ace-1.4.4/src/mode-json.js"></script>
  <script src="./lib/ace-1.4.4/src/snippets/json.js"></script>
  <script src="./lib/ace-1.4.4/src/ext-language_tools.js"></script>

  <script src="./lib/mock/mock-min.js"></script>
  <script>

    // 初始化编辑器
    function initAce(elementId) {
      var editor = ace.edit(elementId);
      editor.setTheme("ace/theme/chrome");//设置主题
      var JavaScriptMode = ace.require("ace/mode/json").Mode;
      editor.session.setMode(new JavaScriptMode());//设置程序语言模式


      // 设置自动补全
      var tangideCompleter = {
        getCompletions: function (editor, session, pos, prefix, callback) {
          return callback(null, []);
        }
      };
      editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
      });
      var langTools = ace.require("ace/ext/language_tools");
      langTools.addCompleter(tangideCompleter);

      // 设置全屏
      editor.commands.addCommand({
        name: "fullscreen",
        bindKey: { win: "Ctrl-Enter", mac: "Command-Enter" },
        exec: function (editor) {
          // 通过css来控制全屏
          if (editor.isFullScreen) {
            $('#' + elementId).css({
              position: 'relative',
              left: 0,
              top: 0,
              width: '100%',
              height: '400px',
              'z-index': 'auto'
            })
            editor.resize();
            editor.isFullScreen = false;
            document.body.style.overflow = "auto";
          } else {
            $('#' + elementId).css({
              position: 'fixed',
              left: 0,
              top: 0,
              width: $(window).width(),
              height: $(window).height(),
              'z-index': '1000'
            })
            editor.resize();
            editor.isFullScreen = true;
            document.body.style.overflow = "hidden";
          }
        },
        readOnly: true // 只读下设置可以全屏展示
      });

      //字体大小 这里采用默认
      // editor.setFontSize(18);
      //自动换行,设置为off关闭
      editor.setOption("wrap", "free")
      editor.getSession().setTabSize(2);// 设置制表符大小

      return editor;
    }

    var editorBase = initAce('base-data');
    var editorBasePage = initAce('base-page-data');

    var baseId = '';
    var basePageId = '';

    // 封装alert
    function alertInfo(content, type) {
      $('#alert').text(content);
      var alertEle = document.getElementById('alert');
      alertEle.className = 'alert position-fixed w-50' + ' alert-' + (type || 'success');
      $('#alert').fadeIn('fast');

      setTimeout(() => {
        $('#alert').fadeOut(2500);
      }, 2500);
    }

    // 切换预览与编辑
    function changePreview(owner, isPreview) {
      if (isPreview) {
        $('#interface-data').hide();
        $('#preview').show();
        $(owner).removeClass('btn-outline-primary').addClass('btn-primary');
        $(owner).prev().removeClass('btn-primary').addClass('btn-outline-primary');

        //mock
        try {
          var mock = JSON5.parse(editor.getValue());
          $('#preview').val(JSON.stringify(Mock.mock(mock), null, 4));
        } catch (reason) {
          $('#preview').val('格式错误:' + reason);
        }
      } else {
        $('#interface-data').show();
        $('#preview').hide();
        $(owner).removeClass('btn-outline-primary').addClass('btn-primary');
        $(owner).next().removeClass('btn-primary').addClass('btn-outline-primary');
      }
    }

    $.get('/api/get-base-list', {}, function (data) {
      if (data.success && data.length != 0) {
        data.data.forEach((item) => {
          if (item.type == 'base-data') {
            editorBase.setValue(JSON5.parse(item.aceData));
            baseId = item._id;
          } else {
            editorBasePage.setValue(JSON5.parse(item.aceData));
            basePageId = item._id;
          }
        })
      }
    })

    // 保存基础数据
    function saveBase() {
      var data = editorBase.getValue();

      try {
        var json5Data = JSON5.parse(data);
      } catch (reason) {
        alertInfo(reason, 'danger');
        return;
      }
      $.ajax({
        url: '/api/update-base-data',
        method: 'post',
        dataType: "json",
        data: JSON.stringify({
          id: baseId,
          name: '响应体基础数据',
          type: 'base-data',
          aceData: JSON5.stringify(data),
          data: json5Data
        }),
        contentType: "application/json",
        success: function (data) {
          if (data.success) {
            alertInfo('保存成功');
          } else {
            alertInfo(data.errorMsg, 'danger');
          }
        }
      })
    }

    // 保存基础分页数据
    function saveBasePage() {
      var data = editorBasePage.getValue();

      try {
        var json5Data = JSON5.parse(data);
      } catch (reason) {
        alertInfo(reason, 'danger');
        return;
      }
      $.ajax({
        url: '/api/update-base-data',
        method: 'post',
        dataType: "json",
        data: JSON.stringify({
          id: basePageId,
          name: '响应体基础分页数据',
          type: 'base-data-page',
          aceData: JSON5.stringify(data),
          data: json5Data
        }),
        contentType: "application/json",
        success: function (data) {
          if (data.success) {
            alertInfo('保存成功');
          } else {
            alertInfo(data.errorMsg, 'danger');
          }
        }
      })
    }

  </script>
</body>

</html>